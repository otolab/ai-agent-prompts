# テストの分類と基本方針

## テストの分類定義

### 1. ユニットテスト (Unit Tests)

**定義**: 単一のモジュール、クラス、関数の振る舞いを検証するテスト

**特徴**:
- 外部依存はすべてモック化
- 高速実行（ミリ秒単位）
- 内部実装の詳細をテスト
- ホワイトボックステスト

**配置例**: 
- `src/**/*.test.ts`
- `src/**/*.spec.ts`
- テスト対象と同じディレクトリに配置

**対象例**:
- 純粋関数の入出力検証
- クラスの個別メソッド
- 状態管理ロジック
- バリデーション処理

### 2. インターフェーステスト (Interface Tests)

**定義**: モジュールの公開インターフェース仕様を検証するテスト

**特徴**:
- モジュールの公開API（exports）のみをテスト
- 内部実装には依存しない
- インターフェース契約の遵守を保証
- ブラックボックステスト

**配置例**: 
- `test/interface/**/*.test.ts`
- `tests/api/**/*.test.ts`

**対象例**:
- 公開メソッドの仕様確認
- APIエンドポイントの契約
- パッケージのexportsが期待通りの型と動作を提供することの確認

### 3. 統合テスト (Integration Tests)

**定義**: 複数のモジュール間の相互作用を検証するテスト

**特徴**:
- 実際のモジュール間連携を確認
- 一部の外部システム（DB等）はモック可
- システムの部分的な結合をテスト
- 中速実行（100ms-1s/test）

**配置例**: 
- `test/integration/**/*.test.ts`
- `tests/integration/**/*.test.ts`

**対象例**:
- モジュール間のデータフロー
- イベント駆動型処理の連鎖
- サービス間の通信
- トランザクション処理

### 4. システムテスト (System Tests)

**定義**: 実際の外部システムと接続して動作を検証するテスト

**特徴**:
- 実際のDB、外部API等を使用
- 環境依存（Docker、実DBが必要）
- 実際の子プロセス起動を含む
- 中速実行（1-5s/test）

**配置例**:
- `test/system/**/*.test.ts`
- DB固有: `db/test/system/**/*.test.ts`

**対象例**:
- 実DBへのCRUD操作
- 外部プロセスとの通信
- ファイルシステム操作
- ネットワーク通信

### 5. E2Eテスト (End-to-End Tests)

**定義**: ユーザー視点でシステム全体の動作を検証するテスト

**特徴**:
- システム全体を起動
- 実際のユーザーシナリオを再現
- 最も現実に近い環境
- 低速実行（5s以上/test）

**配置例**: 
- `test/e2e/**/*.test.ts`
- `e2e/**/*.test.ts`

**対象例**:
- 完全なユーザーフロー
- APIからUIまでの一連の操作
- 複数システムの連携シナリオ

## テスト実行戦略

### 実行コマンドの構成

```bash
# ユニットテスト
npm test                    # 全パッケージのユニットテスト（高速）
npm run test:unit           # 明示的にユニットテストのみ

# インターフェーステスト
npm run test:interface      # 全インターフェーステスト

# 統合テスト
npm run test:integration    # 統合テスト実行

# システムテスト（要Docker/実環境）
npm run test:system         # システムテスト実行

# E2Eテスト（要完全環境）
npm run test:e2e           # E2Eテスト実行

# 組み合わせ実行
npm run test:ci            # CI用（ユニット＋統合）
npm run test:all           # 全テスト段階実行
```

### CI/CDでの実行順序

1. **ユニットテスト** - 最速、常に実行
2. **インターフェーステスト** - 高速、常に実行
3. **統合テスト** - 中速、PR時実行
4. **システムテスト** - 低速、マージ前実行
5. **E2Eテスト** - 最遅、リリース前実行

## 共通セットアップパターン

### グローバルセットアップ（統合・システムテスト用）

```typescript
// test/setup/global.ts
let globalResources: GlobalResources;

export async function setupTestEnvironment() {
  if (!globalResources) {
    globalResources = await initializeResources();
  }
  return globalResources;
}

export async function teardownTestEnvironment() {
  if (globalResources) {
    await globalResources.cleanup();
  }
}
```

### テストヘルパー

```typescript
// test/helpers/test-utils.ts
export function createTestContext() {
  return {
    // 共通のテストユーティリティ
  };
}

export async function waitForCondition(
  condition: () => boolean,
  timeout = 5000
) {
  // 条件待機ユーティリティ
}
```

## テスト実装の指針

### 新機能開発時
1. インターフェーステストで仕様を定義
2. ユニットテストで内部実装を保証
3. 統合テストで他モジュールとの連携確認

### バグ修正時
1. バグを再現するテストを先に書く
2. 該当レベルのテストで修正を確認
3. リグレッションテストとして保持

### リファクタリング時
1. インターフェーステストが通ることを確認
2. 内部実装（ユニットテスト）は必要に応じて更新
3. パフォーマンステストで改善を確認

## モックの使用方針

### 原則
- **最小限のモック**: 必要最小限に留める
- **実装より振る舞い**: 実装詳細ではなく振る舞いをモック
- **明示的な依存関係**: モックする理由を明確に

### モック対象の判断基準
- **モックすべき**: 外部API、ファイルシステム、時間、乱数
- **モックを避ける**: ビジネスロジック、データ変換、純粋関数
- **状況による**: DB（テストレベルによる）、ログ出力

## テストの品質指標

### カバレッジ目標
- ユニットテスト: 80%以上
- 統合テスト: 主要フロー100%
- E2Eテスト: クリティカルパス100%

### テストの独立性
- 各テストは他のテストに依存しない
- 並行実行可能
- 実行順序に依存しない

### アサーションの品質
- 明確な期待値
- 適切なエラーメッセージ
- 境界値のテスト

## パフォーマンス考慮事項

### テスト高速化
- 並列実行の活用
- 共有リソースの再利用
- 不要な待機時間の削減

### リソース管理
- テスト後のクリーンアップ徹底
- メモリリークの防止
- ファイルディスクリプタの適切な管理

---
**作成日**: 2025年1月
**用途**: 汎用的なテスト戦略テンプレート