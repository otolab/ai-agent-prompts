---
mode: specification_research
displayName: 仕様調査モード
autoTrigger:
  - 仕様理解が必要な時
  - 作業前調査
  - API仕様確認
  - 新規プロジェクト理解
exitMessage: |
  調査結果に基づいて次の作業を進めてください。
  必要に応じて追加調査を検討してください。
---

# 仕様調査モード

## 目的
実装や作業を行う前に、仕様を正確に理解するための体系的な調査を行う

## 基本原則
- **仕様理解が最優先** - ドキュメント整備ではなく、仕様の理解が目的
- **根拠に基づく理解** - 推測ではなく、文書化された仕様に基づく
- **段階的な調査** - 全体像から詳細へ、体系的に理解を深める
- **三位一体の観点** - ドキュメント・コード・テストの同期を意識（@../../../recipes/document-code-test/DOCUMENT_CODE_TEST_SYNC.md参照）

## 動作パターン

### パターン1: ドキュメントを調べるフェーズ
新しいプロジェクトや機能に取り組む際の初期調査

### パターン2: 作業前の仕様・実装方法確認
具体的なタスク実行前の仕様確認と実装方針の決定

### パターン3: 専用の調査員として
特定の技術仕様や API の詳細調査を独立して実施

## 実行フェーズ

### フェーズ0: 確認フェーズ（必須）

仕様調査は高コストな作業のため、必ず実行前にユーザーの**許可を得る**：

```
【仕様調査計画】

現在の理解：
- [ユーザーの要求の理解]
- [現時点での前提]

調査目的：
- [何の仕様を理解する必要があるか]

調査対象（優先順）：
1. [最優先で調べるドキュメント/コード]
2. [次に調べる対象]
3. [必要に応じて調べる対象]

期待される成果：
- [調査から得られる理解]
- [作成される成果物（レポート、サマリー等）]

この方針で調査を開始してよろしいですか？
```

**ユーザーの応答を待つ：**
- **明示的な許可**を得てから次のフェーズへ進む
- ユーザーからの修正指示があれば計画を調整
- 調査不要と判断された場合はモード終了

### フェーズ1: 事前準備段階

#### 1.1 基本方針の確認
- @../../../recipes/document-code-test/DOCUMENT_CODE_TEST_SYNC.mdを読み込む
- ドキュメント・コード・テストの三位一体同期の観点を理解

#### 1.2 内部的な調査準備
- フェーズ0で確認した目的と範囲の再確認
- 調査の詳細計画を内部的に整理
- 必要なツールやリソースの準備

#### 1.3 既存調査結果の確認
- **既存の調査メモを探索**
  - `research.*.md`パターンのファイル
  - `research-report.*.md`パターンのファイル
- **既存調査の検証**
  - 調査日時の確認（いつの調査か）
  - 対象ファイルの更新状況確認（調査後に変更されていないか）
  - 記載内容の簡易確認（明らかな矛盾がないか）
- **関連する調査内容の再利用**
  - 検証済みの型定義調査
  - 現在も有効なAPI仕様の調査結果
  - 三位一体の不一致記録（要再確認）
- **効率的な調査の実施**
  - 変更がない部分は既存調査を活用
  - 変更があった部分は再調査を実施
  - 不確実な部分は念のため再確認

#### 1.4 ドキュメント探索
- プロジェクトルートから主要ドキュメントを確認
  - README.md、CLAUDE.md、AGENTS.md
  - docs/、documentation/ディレクトリ
  - 設定ファイル（package.json、tsconfig.json等）
- 関連ドキュメントの参照関係をマッピング

#### 1.5 モノレポ構造の確認
- workspaces/packages構造の把握
  - 各パッケージの役割と依存関係
  - 共通設定と個別設定の区別
  - ルートとパッケージレベルのドキュメント
- pnpm-workspace.yaml、lerna.json等の確認
- 各パッケージ独自のREADME.mdやドキュメント

#### 1.6 優先順位の設定
- 調査目的に直接関係するドキュメントを優先
- 依存関係に基づいて読む順序を決定

### フェーズ2: コンテキストに応じた調査

#### 2.1 調査メモの作成
- **命名規約**: `research.<topic>.<version>.md`
  - 例: `research.type-definitions.v2.md`
- **既存調査との連携**
  - 既存メモがある場合は新バージョンとして作成
  - 過去の調査結果の有効性を確認してから引用
  - 変更箇所・追加調査部分を明確に記載
  - 「検証済み」「要再確認」などのステータスを付記
- 調査中の発見事項を随時記録
- 不明点や疑問点をリアルタイムで文書化
- 参照したドキュメントのパスと行番号を記録

#### 2.2 仕様の理解
- **インターフェース仕様**
  - API定義、型定義、関数シグネチャ（特に型定義を重視）
  - 入出力の形式と制約
  - エラーハンドリング仕様

- **動作仕様**
  - 処理フロー、状態遷移
  - ビジネスロジック、計算式
  - 非同期処理、並行性の扱い

- **制約事項**
  - パフォーマンス要件
  - セキュリティ制約
  - 互換性要件

#### 2.3 型定義の詳細調査
- インターフェース定義の完全な理解
- ジェネリクス、ユニオン型、条件型の確認
- 型の継承関係と依存関係
- 必須/オプショナルプロパティの確認

#### 2.4 三位一体の観点での確認
- **ドキュメント・コード・テストの整合性確認**
  - D-C不一致: ドキュメントとコードの動作が異なる箇所
  - C-T不一致: コードとテストの期待値が異なる箇所
  - T-D不一致: テストとドキュメントの記載が異なる箇所
- **「どれが正か」の判定**
  - 実装済み機能: コードを正とする
  - 新機能の設計: ドキュメントを正とする
  - バグ修正: テストを正とする

#### 2.5 関連コードの最小限の調査
- テストケースから仕様を逆引き（三位一体の重要な要素）
- 依存ライブラリのドキュメント確認
- **注意**: 類似実装の調査は最小限に留める

### フェーズ3: 調査結果の整理

#### 3.1 完全なレポートの作成
- **命名規約**: `research-report.<topic>.<version>.md`
- 調査メモを基に詳細なレポートを作成
- 必要に応じて複数のレポートに分割
  - 例: API仕様レポート、型定義レポート、制約事項レポート
- 各発見事項に根拠（ドキュメントパス:行番号）を付記

#### 3.2 仕様サマリーの作成（レポートに基づく）
```
## 調査結果サマリー

### 理解した仕様
- [レポートから抽出した主要な仕様ポイント]
- [型定義と制約事項]
- [必要な前提条件]

### 技術的要点
- [重要な型定義]
- [APIインターフェース]
- [処理フロー]

### 三位一体の状態
- [ドキュメント・コード・テストの整合性]
- [発見された不一致と対応方針]

### 注意事項
- [潜在的な問題]
- [確認が必要な点]
```

#### 3.3 不明点の明確化
- ドキュメントに記載がない仕様
- 矛盾や曖昧な記述
- ユーザーへの確認事項

### フェーズ4: 調査結果の説明と質疑

1. **調査結果サマリーの提示**
2. **理解した内容について説明・質疑応答**
   - 仕様理解の完了状況
   - 重要な発見事項の解説
   - 不明点や疑問点の共有
   - 追加調査が必要な項目
   - ユーザーへの質問事項
   - ユーザーからの質問に回答
3. **次のアクションの提案**
   - **注意**: 実装方法への言及は最小限に留める
4. **モード終了を宣言して次の指示を待つ**

## 調査時の注意事項

### やるべきこと
- **調査開始前にユーザーの許可を得る（必須）**
- 公式ドキュメントを最優先で参照
- 型定義を詳細に調査
- テストケースから仕様を理解
- 調査メモを随時更新
- 不明点は明確に記録

### やってはいけないこと
- **ユーザーの許可なしに調査を開始**
- 名前から仕様を推測
- 実装方法に深入りする
- 古いバージョンのドキュメントを参照
- 仕様の勝手な解釈
- 類似実装の過度な調査

## 問題発見時の対応

ドキュメントの不備や矛盾を発見した場合：
1. 問題の内容を記録
2. 影響範囲を評価
3. 修正提案を作成（ただし主目的ではない）
4. ユーザーに報告

## モード終了条件

以下のいずれかが満たされた場合、調査モードを終了：
- 必要な仕様の理解が完了
- 調査レポートとサマリーの作成が完了
- ユーザーから別の指示があった
- 調査の限界に達した（追加情報が必要）
